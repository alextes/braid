Below is a **detailed, implementation-ready v0.1 spec** for **`braid` / `brd`** based on everything we agreed.

Open questions are resolved with sane defaults; anything truly “future” is called out explicitly as a future suggestion (but not required for v0.1).

---

# Braid v0.1 Specification

## 1) Purpose

`brd` is a lightweight, repo-local issue tracker built around:

- **issues as files** in the repository (`.braid/issues/*.md`)
- **dependency graph** (DAG recommended; cycles detected)
- **deterministic “ready” & “next”** selection
- **Mode 1 multi-agent concurrency** on a single machine using **git worktrees**, with **cross-worktree locking + claims** stored in the **git common directory** (machine-local, not committed)

Non-goals (v0.1):

- no daemon
- no background sync
- no caching/index DB
- no query language
- no compaction/summarization
- no distributed (cross-machine) coordination (we leave a door open, but it’s not part of v0.1)

---

## 2) Terminology

- **Issue**: a unit of work tracked by `brd` (your “bead/strand”).
- **Dependency**: `A` depends on `B` means “A is blocked until B is done”.
- **Ready issue**: `status == todo` AND all dependencies exist AND are `done`.
- **Blocked issue** (derived): any issue that is not ready due to at least one dependency not `done`, or missing deps, or cycle issues.
- **Claim**: a machine-local lease indicating an agent is working on (or has reserved) an issue. Claims prevent multiple agents from picking the same issue.
- **Control root**: the single worktree on the machine that is treated as the canonical location for `.braid/issues` (prevents branch divergence of issue state across worktrees).

---

## 3) On-disk layout

### 3.1 Tracked (in repo)

At repo root of the **control root** worktree:

```
.braid/
  config.toml
  issues/
    <issue_id>.md
  .gitignore
```

`.braid/.gitignore` (tracked) MUST include at least:

```
agent.toml
runtime/
```

Notes:

- `.braid/runtime/` is reserved for future local-only data (v0.1 may not use it).
- `.braid/agent.toml` is per-worktree and gitignored.

---

## 4) Git integration and discovery

### 4.1 Repo discovery

Every `brd` invocation MUST locate:

1. **worktree root**
   via `git rev-parse --show-toplevel`

2. **git common dir** (shared by all worktrees)
   via `git rev-parse --git-common-dir`

If either command fails:

- The command MUST fail with a clear error (“not a git repository”).

### 4.2 Shared machine-local directory (git common dir)

Inside the git common dir, `brd` uses:

```
<git-common-dir>/brd/
  lock
  control_root
  claims/
    <issue_id>.toml
```

This directory is **machine-local** and **not committed**.

---

## 5) Control root

### 5.1 Rationale

If multiple worktrees each modify their own `.braid/issues`, issue state diverges by branch. For Mode 1 multi-agent to be reliable, we standardize on a single “control root” worktree that owns the canonical `.braid/issues` directory.

### 5.2 Storage

`<git-common-dir>/brd/control_root` is a UTF-8 text file containing an absolute path to the control-root worktree’s top-level directory.

### 5.3 Resolution order

When `brd` needs to read/write issues, it determines control root as:

1. `BRD_CONTROL_ROOT` environment variable (absolute or relative; must be resolved to an absolute canonical path)
2. `<git-common-dir>/brd/control_root` (if exists)
3. fallback: current worktree root (from `--show-toplevel`), **with a warning** that control root was not configured

### 5.4 Initialization

`brd init` MUST:

- create `.braid/` structure in the current worktree root
- set `<git-common-dir>/brd/control_root` to the current worktree root (unless `BRD_CONTROL_ROOT` is set, in which case it uses that value)

---

## 6) Configuration

### 6.1 `.braid/config.toml` (tracked)

Minimal config:

```toml
brd = 1
id_prefix = "repo"   # default derived, see below
id_len = 6           # suffix length, base36 lowercase
```

#### `id_prefix` default derivation

Default is the first 4 alphanumeric chars of the repo directory name (basename of control root), lowercased, non `[a-z0-9]` removed.

If fewer than 4 remain, pad with `x` to length 4.

Examples:

- `my-repo` → `myre`
- `A!` → `axxx`

#### `id_len`

Default 6. Must be between 4 and 10 (v0.1 constraint).

### 6.2 Worktree-local agent file (gitignored)

`.braid/agent.toml` (in each worktree you run an agent from):

```toml
agent_id = "agent-a"
```

---

## 7) Issue IDs

### 7.1 Format

Issue ID MUST be:

`<prefix>-<suffix>`

- `<prefix>`: `[a-z0-9]{2,12}` (v0.1 constraint; default derived as above)
- `<suffix>`: base36 lowercase `[0-9a-z]{id_len}` (default length 6)

Example: `mevx-k3f9qa`

### 7.2 Generation

`brd add` MUST generate random suffix using a cryptographically strong RNG (e.g., OS randomness).

Collision handling:

- `brd add` MUST check if `.braid/issues/<id>.md` already exists (in control root).
- If collision, regenerate and retry up to 20 times, then fail with an error.

### 7.3 ID input resolution (user convenience)

Commands accepting an issue identifier MUST accept:

- Full ID: `mevx-k3f9qa`
- Suffix-only: `k3f9qa` **if unique** within the repo
- Prefix + partial suffix: `mevx-k3f` **if unique**
- Any prefix-less partial that resolves uniquely is permitted (optional), but ambiguity MUST error.

Resolution MUST be done by scanning known issue IDs from `.braid/issues/`.

If zero matches → “issue not found” error.
If >1 matches → “ambiguous id” error listing candidates.

Dependencies stored in files MUST always be full IDs.

---

## 8) Issue file format

### 8.1 File location and naming

Each issue is stored as:

`.braid/issues/<issue_id>.md` (within the **control root**)

### 8.2 Content structure

Each file begins with YAML frontmatter delimited by `---` lines, followed by optional Markdown body.

Example:

```md
---
brd: 1
id: "mevx-k3f9qa"
title: "implement brd ready"
priority: "P1"
status: "todo"
deps: ["mevx-1a2b3c"]
owner: null
created_at: 2025-12-25T12:00:00Z
updated_at: 2025-12-25T12:00:00Z
acceptance:
  - "ready includes only todo with all deps done"
---

Markdown description here.
```

### 8.3 Required fields

- `brd`: integer schema version, MUST be `1` in v0.1
- `id`: string, MUST equal filename stem
- `title`: string, non-empty
- `priority`: `"P0" | "P1" | "P2" | "P3"`
- `status`: `"todo" | "doing" | "done"`
- `deps`: list of strings (issue IDs), MAY be empty
- `created_at`: ISO 8601 UTC timestamp (`...Z`)
- `updated_at`: ISO 8601 UTC timestamp (`...Z`)

### 8.4 Optional fields

- `owner`: string or null
- `acceptance`: list of strings
- additional unknown keys allowed (for forward compatibility)

### 8.5 Normalization rules (writing)

When `brd` modifies an issue (start/done/dep/etc.) it MUST:

- parse frontmatter
- update only relevant fields
- preserve:
  - Markdown body verbatim
  - unknown frontmatter keys (do not drop)

- rewrite frontmatter in a **stable canonical order** for known keys:

Order (v0.1):

1. brd
2. id
3. title
4. priority
5. status
6. deps
7. owner
8. created_at
9. updated_at
10. acceptance
11. unknown keys (sorted lexicographically, or preserved order if easy)

### 8.6 Validation rules

- `id` must match filename
- `deps` may not contain self (`id`)
- `priority/status` are case-insensitive on input, but MUST be normalized to canonical casing on write (`P1`, `todo`, etc.)
- `created_at` never changes after creation
- `updated_at` MUST update on any modification by `brd`

---

## 9) Dependency graph semantics

### 9.1 Dependency meaning

`deps` is the list of issues that **block** this issue.

`A.deps = [B, C]` means “A is blocked by B and C.”

### 9.2 Ready definition (v0.1)

Issue `A` is **ready** iff:

- `A.status == "todo"`
- AND for every `d in A.deps`:
  - issue `d` exists
  - issue `d.status == "done"`

If any dep is missing or not done, `A` is not ready.

### 9.3 Cycle handling

Cycles are invalid for “ready” semantics.

- `brd doctor` MUST detect cycles and report them.
- For `brd ready/next`, any issue participating in a cycle MUST be treated as **not ready** (blocked).

(Exact cycle reporting format is defined under `doctor`.)

---

## 10) Mode 1 multi-agent claims & locking (file-based)

### 10.1 Agent identity

Agent ID resolution order:

1. `BRD_AGENT_ID` environment variable
2. `.braid/agent.toml` in the current worktree root
3. fallback generated value: `<hostname>:<pid>`

### 10.2 Claim files (machine-local)

Claim files live in:

`<git-common-dir>/brd/claims/<issue_id>.toml`

Format (TOML):

```toml
issue_id = "mevx-k3f9qa"
agent_id = "agent-a"
pid = 12345
worktree = "/abs/path/to/worktree"
branch = "agent-a"
claimed_at = 1735123456
lease_until = 1735124056
```

- `claimed_at` and `lease_until` are unix epoch seconds (UTC).
- `worktree` is the current worktree top-level.
- `branch` should be best-effort (e.g., `git rev-parse --abbrev-ref HEAD`), but failures must not break core behavior.

### 10.3 Lease duration

Default lease duration: **600 seconds (10 minutes)**.

Lease renewal:

- Any successful `claim`, `start`, `next --claim`, or other claim-touching operation MUST renew the lease for claims held by that agent on that issue.
- (Future: TUI will periodically renew while running.)

Expired claims:

- If `lease_until < now`, claim is considered inactive and may be replaced (“stolen”) by another agent.

### 10.4 Global lock

All mutating operations MUST take an exclusive lock on:

`<git-common-dir>/brd/lock`

Implementation requirement:

- Use an OS advisory lock (e.g., `flock`-style). In Rust, commonly via `fs2::FileExt::lock_exclusive()`.

Mutating operations include:

- `init`
- `add`
- `dep add`, `dep rm`
- `claim`, `release`, `reclaim`
- `start`, `done`
- `next --claim`
- `migrate` (future)

Non-mutating operations include:

- `ls`, `show`, `ready`, `next` (without `--claim`), `doctor`, `claims`, `completions`

### 10.5 Atomic claim file writes

To avoid partial writes:

- write to `claims/<issue_id>.toml.tmp.<pid>`
- fsync if practical
- atomically rename to `claims/<issue_id>.toml`

### 10.6 Claim conflict rules

- If issue is claimed by another agent and claim is **active**, operations that require ownership MUST fail with a **claim-conflict** error.
- If claim is expired, it may be replaced without user interaction (except where noted).

Ownership requirement (v0.1 defaults):

- `start` requires that the caller can obtain the claim (unclaimed / expired / already owned).
- `done` requires claim ownership, unless `--force`.
- `release` requires claim ownership, unless `--force`.
- `reclaim` succeeds if claim is expired; requires `--force` if not expired.

### 10.7 Opportunistic cleanup (optional but recommended)

Under the global lock, claim-touching commands MAY delete claim files that are expired **and** older than a safety window (e.g., expired > 24h) to reduce clutter. This is not required for correctness.

---

## 11) Sorting and selection

### 11.1 Priority order

`P0` highest, then `P1`, `P2`, `P3`.

### 11.2 Deterministic ordering (ready/next)

When listing or selecting ready issues, order MUST be:

1. priority (P0 → P3)
2. created_at ascending
3. id lexicographic ascending

### 11.3 “Claim filtering”

By default:

- `brd ready` MUST exclude issues claimed by other agents (active claims)
- it MAY include issues claimed by the current agent (treat as available)
- `--include-claimed` includes all ready issues and annotates claim holder

`brd next --claim` MUST select among “ready and not actively claimed by another agent”.

---

## 12) CLI specification

### 12.1 Global flags

All commands support:

- `--json`
  output machine-readable JSON instead of human format

- `--repo <path>` (optional)
  run as if invoked from within that directory (used for scripting); affects git discovery.

- `--no-color`
  disables ANSI colors in human output

Environment:

- `NO_COLOR` should behave like `--no-color`.

### 12.2 Output JSON conventions

When `--json` is used:

- output MUST be a single JSON object or array to stdout
- human-oriented logs MUST go to stderr (or be suppressed)
- errors MUST include a stable `code` field

Standard issue JSON object (used by `ls`, `show`, `ready`, etc.):

```json
{
  "id": "mevx-k3f9qa",
  "title": "implement brd ready",
  "priority": "P1",
  "status": "todo",
  "deps": ["mevx-1a2b3c"],
  "owner": null,
  "created_at": "2025-12-25T12:00:00Z",
  "updated_at": "2025-12-25T12:00:00Z",
  "acceptance": ["..."],
  "derived": {
    "is_ready": false,
    "open_deps": ["mevx-1a2b3c"],
    "missing_deps": [],
    "is_blocked": true
  },
  "claim": {
    "state": "unclaimed",
    "agent_id": null,
    "lease_until": null
  }
}
```

Claim `state` values:

- `unclaimed`
- `claimed_by_me`
- `claimed_by_other`
- `expired` (if a claim exists but is expired; may appear with `--include-claimed`)

### 12.3 Commands

#### `brd init`

Creates `.braid/` scaffolding in the current worktree root.

Behavior:

- create `.braid/issues/` if missing
- create `.braid/config.toml` if missing (with defaults)
- create/ensure `.braid/.gitignore` contains required entries
- create `<git-common-dir>/brd/` and `<git-common-dir>/brd/claims/` if missing
- write `<git-common-dir>/brd/control_root` unless already present (or overwrite if `--force` future; v0.1 default: do not overwrite, warn)

Output:

- prints where control root and common dir are located

Errors:

- not a git repo
- cannot write

---

#### `brd add "<title>" [--priority P0|P1|P2|P3] [--dep <id>...] [--ac "<text>" ...]`

Creates a new issue file in control root.

Rules:

- generates ID using config prefix + random suffix
- status defaults to `todo`
- sets `created_at` and `updated_at` to now
- deps are resolved to full IDs and stored as full IDs

Output (human):

- prints created ID and path

Output (`--json`):

- returns the full issue JSON object

---

#### `brd ls [--status todo|doing|done] [--priority P0..P3] [--ready] [--blocked]`

Lists issues from control root.

Rules:

- `--ready` filters to ready issues (as defined)
- `--blocked` filters to blocked issues (derived)
- default sort: priority, created_at, id

Output (human):

- one line per issue: `id  P1  todo  title (deps:2 open:1) [claim:agent-a]`

Output (`--json`):

- JSON array of issue objects

---

#### `brd show <id>`

Shows one issue.

Rules:

- resolves `<id>` using resolution rules
- includes derived + claim info

Output (human):

- prints frontmatter fields, deps status, and markdown body

Output (`--json`):

- issue object

---

#### `brd ready [--include-claimed]`

Lists ready issues.

Rules:

- ready definition as above
- default excludes active claims by other agents
- stable sort

Output (`--json`):

- array of issue objects

---

#### `brd next [--claim] [--include-claimed]`

Selects the “next” issue (top of the ready list).

Without `--claim`:

- returns the first issue in the ready list (respecting claim filtering)

With `--claim`:

- MUST take global lock
- recompute ready list
- pick first ready issue not actively claimed by another agent
- write/renew claim for caller
- returns the claimed issue

If no eligible issues:

- returns empty output in human mode (“no ready issues”)
- returns `null` in JSON mode

---

#### `brd claim <id>`

Acquires or renews claim for an issue.

Rules:

- MUST take global lock
- If claimed by other and active → error
- If claim expired → steal
- If unclaimed or claimed by me → write/renew

Output:

- human: “claimed <id> until <time>”
- json: claim object

---

#### `brd release <id> [--force]`

Releases a claim.

Rules:

- MUST take global lock
- If claimed by me → delete claim file
- If claimed by other and `--force` not set → error
- With `--force` → delete claim file

---

#### `brd claims [--all]`

Lists claims (machine-local).

Default:

- show only active claims

With `--all`:

- include expired claims and mark them

Output (`--json`):

- array of claim objects

---

#### `brd reclaim <id> [--force]`

Steals a claim.

Rules:

- MUST take global lock
- If claim expired → take it
- If not expired:
  - with `--force` → take it
  - else → error

---

#### `brd start <id>`

Marks an issue as “doing” (and claims it).

Rules:

- MUST take global lock
- MUST successfully obtain claim (same semantics as `claim`)
- Updates issue:
  - `status = "doing"`
  - `owner = agent_id`
  - `updated_at = now`

- Does NOT require issue to be ready (blocked is derived only)

---

#### `brd done <id> [--force]`

Marks an issue as “done”.

Rules:

- MUST take global lock
- Requires claim ownership unless `--force`
- Updates issue:
  - `status = "done"`
  - `owner = null` (v0.1 default)
  - `updated_at = now`

- Releases claim (unless `--no-release` future; v0.1 always releases)

---

#### `brd dep add <child> <parent>`

Adds a dependency.

Meaning:

- `child` depends on `parent` (parent blocks child)

Rules:

- MUST take global lock
- Resolve IDs to full IDs
- Add parent to `child.deps` if not present
- Update `updated_at`
- MUST NOT introduce self-dep
- MAY allow cycles but doctor will flag; (v0.1 recommendation: do not block the add, just warn in output; strict cycle prevention is future)

---

#### `brd dep rm <child> <parent>`

Removes a dependency.

Rules:

- MUST take global lock
- Resolve IDs
- Remove parent if present
- Update `updated_at`

---

#### `brd doctor`

Validates repo state.

Checks (MUST):

- `.braid/` exists in control root
- all issue files parse
- `brd` schema version supported (1)
- required fields present and valid
- `id` matches filename
- deps refer to existing issues (missing deps reported)
- cycles detected and reported

Output (human):

- grouped errors/warnings with file paths and ids

Output (`--json`):

- object like:

```json
{
  "ok": false,
  "errors": [
    { "code": "missing_dep", "issue": "mevx-a1b2c3", "dep": "mevx-deadbe" },
    { "code": "cycle", "cycle": ["mevx-aaaaaa", "mevx-bbbbbb", "mevx-aaaaaa"] }
  ],
  "warnings": []
}
```

Exit:

- 0 if no errors
- nonzero if errors

---

#### `brd completions <shell>`

Generates shell completion scripts.

Supported shells (v0.1):

- `bash`, `zsh`, `fish`, `powershell`, `elvish`

Output:

- completion script to stdout

---

## 13) Exit codes (stable, automation-friendly)

v0.1 MUST use these exit codes:

- `0`: success
- `2`: CLI usage error / invalid arguments
- `10`: not a git repository / cannot discover git dirs
- `11`: control root not found / invalid
- `12`: issue not found
- `13`: ambiguous issue id
- `14`: claim conflict (claimed by other, active lease)
- `15`: invalid graph (cycle) — used by `doctor` (and optionally by strict ops if added later)
- `16`: schema/parse error for issue files
- `1`: other generic failure

When `--json`, errors MUST print a JSON object to stdout or stderr consistently (recommended: stdout), e.g.:

```json
{
  "ok": false,
  "code": "claim_conflict",
  "message": "issue claimed by agent-b until ...",
  "exit": 14
}
```

---

## 14) Implementation notes (Rust)

This section is normative insofar as it affects behavior.

### 14.1 Recommended crates

- CLI: `clap`, `clap_complete`
- YAML frontmatter: `serde`, `serde_yaml`
- TOML config/claims: `toml`
- Locking: `fs2` (file locks)
- Random: `rand` + OS RNG (`rand::rngs::OsRng`)
- Time: `time` (UTC ISO8601)
- Errors: `anyhow` + `thiserror`

### 14.2 Module boundaries (to keep it simple)

- `repo`: git discovery, control root resolution
- `config`: read/write `.braid/config.toml`
- `issue`: parse/write markdown issue files + normalization
- `graph`: ready computation, open deps, cycle detection
- `claims`: claim read/write, lease logic, agent_id resolution
- `lock`: global lock operations
- `cli`: command wiring

---

## 15) TUI (future suggestion, not required in v0.1)

Command: `brd tui`

- shows “Ready” and “All” lists, detail pane
- uses the same core primitives as CLI
- primary collision-proof action uses `next --claim` internally
- periodically renews leases for currently claimed issues held by the agent

(We intentionally build it after the CLI is dogfoodable.)

---

## 16) Mode 2 distributed (future suggestion only)

Not in v0.1. If you later want cross-machine:

- claims would need to be syncable and mergeable (likely one-file-per-claim in a dedicated branch or a separate remote/submodule-like repo)
- conflict resolution becomes an explicit part of design
- v0.1’s separation (“canonical issues are files; claims are separate”) keeps that door open.

---

# Minimal “first milestone” checklist (what v0.1 should ship with)

Required:

- `init`, `add`, `ls`, `show`
- dependency edits (`dep add/rm`)
- graph logic: `ready`, `next`, deterministic sorting
- Mode 1 concurrency: control root + common-dir global lock + claim files + leases
- workflow: `claim`, `release`, `reclaim`, `claims`, `start`, `done`
- `doctor`
- `completions`

Deferred:

- TUI (`brd tui`)
- auto-commit helpers
- strict cycle-prevention on dep edits

---

If you want, next we can turn this spec into:

- a **concrete file format test suite** (golden files)
- a **CLI contract test plan** (exit codes + JSON schemas)
- and then a clean Rust workspace layout with the first set of commands wired end-to-end.
